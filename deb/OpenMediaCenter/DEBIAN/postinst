#!/bin/bash
# enable nginx site
ln -sf /etc/nginx/sites-available/OpenMediaCenter.conf /etc/nginx/sites-enabled/OpenMediaCenter.conf

# link general socket to current one
phpsymlink="/var/run/php/php-fpm.sock";

# create a gneral symlink to the php socket if not already existing
if [ -L ${phpsymlink} ] ; then
   if [ -e ${phpsymlink} ] ; then
      echo "general php symlink already exists."
   else
      ln -sf /var/run/php/php*.*-fpm.sock /var/run/php/php-fpm.sock
   fi
else
   ln -sf /var/run/php/php*.*-fpm.sock /var/run/php/php-fpm.sock
fi

# setup database
mysql -uroot -pPASS -e "CREATE DATABASE IF NOT EXISTS mediacenter;"
mysql -uroot -pPASS -e "CREATE USER IF NOT EXISTS 'mediacenteruser'@'localhost' IDENTIFIED BY 'mediapassword';"
mysql -uroot -pPASS -e "GRANT ALL PRIVILEGES ON mediacenter . * TO 'mediacenteruser'@'localhost';"
mysql -u mediacenteruser -pmediapassword mediacenter < /tmp/openmediacenter.sql

# removed unused sql style file
rm /tmp/openmediacenter.sql

# correct user rights
chown -R www-data:www-data /var/www/openmediacenter

# restart services
systemctl restart nginx

# trigger a movie reindex
php /var/www/openmediacenter/api/extractvideopreviews.php
